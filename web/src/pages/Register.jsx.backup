import { useState, useEffect, useRef } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';
import { authAPI, bigdataAPI, workersAPI } from '../api/client';
import api from '../api/client';
import LocationPicker from '../components/LocationPicker';

export default function Register() {
  const navigate = useNavigate();
  const { login, checkAuth } = useAuth();
  const fileInputRef = useRef(null);

  const [step, setStep] = useState(1); // 1: ê³„ì •ì •ë³´, 2: í”„ë¡œí•„ì •ë³´
  const [loading, setLoading] = useState(false);

  // Step 1: ê³„ì • ì •ë³´
  const [email, setEmail] = useState('');
  const [emailChecked, setEmailChecked] = useState(false);
  const [emailAvailable, setEmailAvailable] = useState(false);
  const [checkingEmail, setCheckingEmail] = useState(false);
  const [password, setPassword] = useState('');
  const [passwordConfirm, setPasswordConfirm] = useState('');

  // Step 2: í”„ë¡œí•„ ì •ë³´
  const [name, setName] = useState('');
  const [phone, setPhone] = useState('');
  const [birthDate, setBirthDate] = useState('');
  const [gender, setGender] = useState('');
  const [bankName, setBankName] = useState('');
  const [bankAccount, setBankAccount] = useState('');

  // ì‚¬ì§„ ì—…ë¡œë“œ
  const [photoFile, setPhotoFile] = useState(null);
  const [photoPreview, setPhotoPreview] = useState(null);
  const [compressing, setCompressing] = useState(false);

  // ê±°ì£¼ì§€ ì£¼ì†Œ (ì¹´ì¹´ì˜¤ë§µ)
  const [residence, setResidence] = useState('');
  const [residenceLat, setResidenceLat] = useState(null);
  const [residenceLng, setResidenceLng] = useState(null);

  useEffect(() => {
    window.scrollTo(0, 0);
  }, [step]);

  const handleResidenceSelect = (address, latitude, longitude) => {
    setResidence(address);
    setResidenceLat(latitude);
    setResidenceLng(longitude);
  };

  // ì´ë¯¸ì§€ ì••ì¶• í•¨ìˆ˜ (ìµœëŒ€ 800px, í’ˆì§ˆ 0.7)
  const compressImage = (file, maxWidth = 800, quality = 0.7) => {
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          let { width, height } = img;

          if (width > maxWidth) {
            height = (height * maxWidth) / width;
            width = maxWidth;
          }

          canvas.width = width;
          canvas.height = height;

          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);

          canvas.toBlob(
            (blob) => {
              const compressedFile = new File([blob], file.name, {
                type: 'image/jpeg',
                lastModified: Date.now(),
              });
              resolve(compressedFile);
            },
            'image/jpeg',
            quality
          );
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    });
  };

  // ì‚¬ì§„ ì„ íƒ í•¸ë“¤ëŸ¬
  const handlePhotoSelect = async (e) => {
    const file = e.target.files[0];
    if (file) {
      if (!file.type.startsWith('image/')) {
        alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤');
        return;
      }

      setCompressing(true);
      try {
        const compressedFile = await compressImage(file, 800, 0.7);
        setPhotoFile(compressedFile);

        const reader = new FileReader();
        reader.onload = (e) => setPhotoPreview(e.target.result);
        reader.readAsDataURL(compressedFile);
      } catch (error) {
        console.error('ì´ë¯¸ì§€ ì••ì¶• ì‹¤íŒ¨:', error);
        setPhotoFile(file);
        const reader = new FileReader();
        reader.onload = (e) => setPhotoPreview(e.target.result);
        reader.readAsDataURL(file);
      } finally {
        setCompressing(false);
      }
    }
  };

  // ì´ë©”ì¼ í˜•ì‹ ê²€ì¦
  const isValidEmail = (value) => {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value);
  };

  // ì´ë©”ì¼ ì¤‘ë³µ ì²´í¬
  const checkEmailDuplicate = async () => {
    if (!email || !isValidEmail(email)) {
      alert('ì˜¬ë°”ë¥¸ ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
      return;
    }

    setCheckingEmail(true);
    try {
      const { data } = await api.get('/api/auth/check-email', { params: { email } });
      setEmailChecked(true);
      setEmailAvailable(data.available);
      if (!data.available) {
        alert('ì´ë¯¸ ì‚¬ìš©ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤');
      }
    } catch (error) {
      alert('ì´ë©”ì¼ í™•ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
    } finally {
      setCheckingEmail(false);
    }
  };

  // ì´ë©”ì¼ ë³€ê²½ ì‹œ ì¤‘ë³µì²´í¬ ì´ˆê¸°í™”
  const handleEmailChange = (e) => {
    setEmail(e.target.value);
    setEmailChecked(false);
    setEmailAvailable(false);
  };

  // ì „í™”ë²ˆí˜¸ í¬ë§·
  const formatPhone = (value) => {
    const numbers = value.replace(/\D/g, '');
    if (numbers.length <= 3) return numbers;
    if (numbers.length <= 7) return `${numbers.slice(0, 3)}-${numbers.slice(3)}`;
    return `${numbers.slice(0, 3)}-${numbers.slice(3, 7)}-${numbers.slice(7, 11)}`;
  };

  // ìƒë…„ì›”ì¼ í¬ë§· (YYYY-MM-DD)
  const formatBirthDate = (value) => {
    const numbers = value.replace(/\D/g, '');
    if (numbers.length <= 4) return numbers;
    if (numbers.length <= 6) return `${numbers.slice(0, 4)}-${numbers.slice(4)}`;
    return `${numbers.slice(0, 4)}-${numbers.slice(4, 6)}-${numbers.slice(6, 8)}`;
  };

  // ìƒë…„ì›”ì¼ ìœ íš¨ì„± ê²€ì‚¬
  const isValidBirthDate = (value) => {
    if (!value) return false;
    const match = value.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (!match) return false;
    const [, year, month, day] = match;
    const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
    return date.getFullYear() === parseInt(year) &&
           date.getMonth() === parseInt(month) - 1 &&
           date.getDate() === parseInt(day) &&
           parseInt(year) >= 1900 && parseInt(year) <= new Date().getFullYear();
  };

  // Step 1 ê²€ì¦
  const validateStep1 = () => {
    if (!email || !isValidEmail(email)) {
      alert('ì˜¬ë°”ë¥¸ ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
      return false;
    }
    if (!emailChecked || !emailAvailable) {
      alert('ì´ë©”ì¼ ì¤‘ë³µí™•ì¸ì„ í•´ì£¼ì„¸ìš”');
      return false;
    }
    if (!password || password.length < 6) {
      alert('ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤');
      return false;
    }
    if (password !== passwordConfirm) {
      alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
      return false;
    }
    return true;
  };

  // Step 2 ê²€ì¦
  const validateStep2 = () => {
    // ëª¨ë“  í•„ìˆ˜ í•„ë“œ ê²€ì¦
    const missingFields = [];

    if (!photoFile) missingFields.push('í”„ë¡œí•„ ì‚¬ì§„');
    if (!name.trim()) missingFields.push('ì´ë¦„');
    if (!phone.trim() || phone.replace(/-/g, '').length < 10) missingFields.push('ì „í™”ë²ˆí˜¸');
    if (!birthDate || !isValidBirthDate(birthDate)) missingFields.push('ìƒë…„ì›”ì¼');
    if (!gender) missingFields.push('ì„±ë³„');
    if (!residence.trim()) missingFields.push('ê±°ì£¼ì§€ì—­');
    if (!bankName.trim()) missingFields.push('ì€í–‰ëª…');
    if (!bankAccount.trim()) missingFields.push('ê³„ì¢Œë²ˆí˜¸');

    if (missingFields.length > 0) {
      alert('í•„ìˆ˜ì‚¬í•­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
      return false;
    }
    return true;
  };

  // ë‹¤ìŒ ë‹¨ê³„
  const handleNextStep = () => {
    if (validateStep1()) {
      setStep(2);
    }
  };

  // íšŒì›ê°€ì… ì™„ë£Œ
  const handleRegister = async () => {
    if (!validateStep2()) return;

    setLoading(true);
    try {
      const { data } = await authAPI.emailRegister({
        email,
        password,
        name: name.trim(),
        phone: phone.replace(/-/g, ''),
        birth_date: birthDate || null,
        gender: gender || null,
        residence: residence || null,
        residence_lat: residenceLat || null,
        residence_lng: residenceLng || null,
        bank_name: bankName || null,
        bank_account: bankAccount || null,
      });

      login(data.access_token, data);
      await checkAuth();

      // ì‚¬ì§„ì´ ìˆìœ¼ë©´ ì—…ë¡œë“œ
      if (photoFile) {
        try {
          await workersAPI.uploadPhoto(photoFile);
        } catch (photoError) {
          console.error('ì‚¬ì§„ ì—…ë¡œë“œ ì‹¤íŒ¨:', photoError);
        }
      }

      alert('íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
      navigate('/');
    } catch (error) {
      const errorDetail = error.response?.data?.detail;
      let errorMessage = 'íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤';
      if (typeof errorDetail === 'string') {
        errorMessage = errorDetail;
      } else if (Array.isArray(errorDetail)) {
        errorMessage = errorDetail.map(e => e.msg || e).join(', ');
      } else if (errorDetail && typeof errorDetail === 'object') {
        errorMessage = errorDetail.msg || JSON.stringify(errorDetail);
      }
      alert(errorMessage);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-white">
      {/* í—¤ë” */}
      <div className="sticky top-0 bg-white border-b z-10">
        <div className="flex items-center h-14 px-4">
          <button onClick={() => step === 1 ? navigate('/login') : setStep(1)} className="mr-4">
            <span className="text-xl">â†</span>
          </button>
          <h1 className="text-lg font-semibold">íšŒì›ê°€ì…</h1>
        </div>
        {/* ì§„í–‰ í‘œì‹œ */}
        <div className="flex px-4 pb-3">
          <div className={`flex-1 h-1 rounded-full mr-1 ${step >= 1 ? 'bg-blue-500' : 'bg-gray-200'}`} />
          <div className={`flex-1 h-1 rounded-full ${step >= 2 ? 'bg-blue-500' : 'bg-gray-200'}`} />
        </div>
      </div>

      <div className="p-6 max-w-md mx-auto">
        {/* Step 1: ê³„ì • ì •ë³´ */}
        {step === 1 && (
          <div className="space-y-6 animate-fade-in">
            <div>
              <h2 className="text-xl font-bold text-gray-900 mb-2">ê³„ì • ì •ë³´ ì…ë ¥</h2>
              <p className="text-gray-500 text-sm">ë¡œê·¸ì¸ì— ì‚¬ìš©í•  ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
            </div>

            {/* ì´ë©”ì¼ */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                ì´ë©”ì¼ <span className="text-red-500">*</span>
              </label>
              <div className="flex gap-2">
                <input
                  type="email"
                  value={email}
                  onChange={handleEmailChange}
                  placeholder="email@example.com"
                  className="input flex-1"
                />
                <button
                  onClick={checkEmailDuplicate}
                  disabled={checkingEmail || !email}
                  className="px-4 py-2 bg-gray-100 text-gray-700 rounded-xl text-sm font-medium whitespace-nowrap disabled:opacity-50"
                >
                  {checkingEmail ? 'í™•ì¸ì¤‘...' : 'ì¤‘ë³µí™•ì¸'}
                </button>
              </div>
              {emailChecked && (
                <p className={`text-sm mt-2 ${emailAvailable ? 'text-green-600' : 'text-red-500'}`}>
                  {emailAvailable ? 'âœ“ ì‚¬ìš© ê°€ëŠ¥í•œ ì´ë©”ì¼ì…ë‹ˆë‹¤' : 'âœ— ì´ë¯¸ ì‚¬ìš©ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤'}
                </p>
              )}
            </div>

            {/* ë¹„ë°€ë²ˆí˜¸ */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                ë¹„ë°€ë²ˆí˜¸ <span className="text-red-500">*</span>
              </label>
              <input
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                placeholder="6ì ì´ìƒ"
                className="input"
              />
            </div>

            {/* ë¹„ë°€ë²ˆí˜¸ í™•ì¸ */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                ë¹„ë°€ë²ˆí˜¸ í™•ì¸ <span className="text-red-500">*</span>
              </label>
              <input
                type="password"
                value={passwordConfirm}
                onChange={(e) => setPasswordConfirm(e.target.value)}
                placeholder="ë¹„ë°€ë²ˆí˜¸ ì¬ì…ë ¥"
                className="input"
              />
              {passwordConfirm && password !== passwordConfirm && (
                <p className="text-sm text-red-500 mt-2">ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤</p>
              )}
              {passwordConfirm && password === passwordConfirm && password.length >= 6 && (
                <p className="text-sm text-green-600 mt-2">âœ“ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•©ë‹ˆë‹¤</p>
              )}
            </div>

            <button
              onClick={handleNextStep}
              className="btn-primary w-full mt-8"
            >
              ë‹¤ìŒ
            </button>

            <p className="text-center text-sm text-gray-500">
              ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”?{' '}
              <button onClick={() => navigate('/login')} className="text-blue-600 font-medium">
                ë¡œê·¸ì¸
              </button>
            </p>
          </div>
        )}

        {/* Step 2: í”„ë¡œí•„ ì •ë³´ */}
        {step === 2 && (
          <div className="space-y-5 animate-fade-in">
            <div>
              <h2 className="text-xl font-bold text-gray-900 mb-2">í”„ë¡œí•„ ì •ë³´ ì…ë ¥</h2>
              <p className="text-gray-500 text-sm">ê·¼ë¬´ì— í•„ìš”í•œ ê¸°ë³¸ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
            </div>

            {/* í”„ë¡œí•„ ì‚¬ì§„ */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                í”„ë¡œí•„ ì‚¬ì§„ (ë©´ì ‘ëŒ€ì²´ìš©) <span className="text-red-500">*</span>
              </label>
              <div className="flex items-center gap-4">
                <div
                  onClick={() => fileInputRef.current?.click()}
                  className="w-20 h-20 rounded-2xl border-2 border-dashed border-gray-300 flex items-center justify-center cursor-pointer overflow-hidden hover:border-blue-400 transition-colors"
                >
                  {compressing ? (
                    <div className="animate-spin rounded-full h-6 w-6 border-2 border-gray-300 border-t-blue-500"></div>
                  ) : photoPreview ? (
                    <img src={photoPreview} alt="ë¯¸ë¦¬ë³´ê¸°" className="w-full h-full object-cover" />
                  ) : (
                    <span className="text-3xl text-gray-400">ğŸ“·</span>
                  )}
                </div>
                <div className="flex-1">
                  <button
                    type="button"
                    onClick={() => fileInputRef.current?.click()}
                    disabled={compressing}
                    className="px-4 py-2 bg-gray-100 text-gray-700 rounded-xl text-sm font-medium"
                  >
                    {compressing ? 'ì••ì¶• ì¤‘...' : photoPreview ? 'ì‚¬ì§„ ë³€ê²½' : 'ì‚¬ì§„ ì„ íƒ'}
                  </button>
                  <p className="text-xs text-gray-500 mt-1">ë©´ì ‘ì„ ëŒ€ì²´í•˜ëŠ” ì‚¬ì§„ì…ë‹ˆë‹¤</p>
                </div>
              </div>
              <input
                ref={fileInputRef}
                type="file"
                accept="image/*"
                onChange={handlePhotoSelect}
                className="hidden"
              />
            </div>

            {/* ì´ë¦„ */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                ì´ë¦„ <span className="text-red-500">*</span>
              </label>
              <input
                type="text"
                value={name}
                onChange={(e) => setName(e.target.value)}
                placeholder="í™ê¸¸ë™"
                className="input"
              />
            </div>

            {/* ì „í™”ë²ˆí˜¸ */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                ì „í™”ë²ˆí˜¸ <span className="text-red-500">*</span>
              </label>
              <input
                type="tel"
                value={phone}
                onChange={(e) => setPhone(formatPhone(e.target.value))}
                placeholder="010-1234-5678"
                className="input"
                maxLength={13}
              />
            </div>

            {/* ìƒë…„ì›”ì¼ */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                ìƒë…„ì›”ì¼ <span className="text-red-500">*</span>
              </label>
              <div className="flex gap-2">
                <input
                  type="text"
                  value={birthDate}
                  onChange={(e) => {
                    const val = e.target.value;
                    // ìˆ«ìì™€ í•˜ì´í”ˆë§Œ í—ˆìš©
                    const cleaned = val.replace(/[^0-9-]/g, '');
                    setBirthDate(formatBirthDate(cleaned));
                  }}
                  placeholder="19900101"
                  className="input flex-1"
                  maxLength={10}
                  pattern="[0-9]*"
                />
                <label className="flex items-center justify-center w-12 h-12 bg-gray-100 rounded-xl cursor-pointer hover:bg-gray-200 transition-colors">
                  <span className="text-xl">ğŸ“…</span>
                  <input
                    type="date"
                    value={birthDate}
                    onChange={(e) => setBirthDate(e.target.value)}
                    className="sr-only"
                  />
                </label>
              </div>
              <p className="text-xs text-gray-500 mt-1">ìˆ«ì 8ìë¦¬ ì…ë ¥ (ì˜ˆ: 19900101) ë˜ëŠ” ğŸ“… í´ë¦­</p>
              {birthDate && !isValidBirthDate(birthDate) && (
                <p className="text-xs text-red-500 mt-1">ì˜¬ë°”ë¥¸ ìƒë…„ì›”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤</p>
              )}
            </div>

            {/* ì„±ë³„ */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                ì„±ë³„ <span className="text-red-500">*</span>
              </label>
              <div className="flex gap-3">
                <button
                  type="button"
                  onClick={() => setGender('M')}
                  className={`flex-1 py-3 rounded-xl font-medium transition-all ${
                    gender === 'M'
                      ? 'bg-blue-500 text-white'
                      : 'bg-gray-100 text-gray-700'
                  }`}
                >
                  ë‚¨ì„±
                </button>
                <button
                  type="button"
                  onClick={() => setGender('F')}
                  className={`flex-1 py-3 rounded-xl font-medium transition-all ${
                    gender === 'F'
                      ? 'bg-blue-500 text-white'
                      : 'bg-gray-100 text-gray-700'
                  }`}
                >
                  ì—¬ì„±
                </button>
              </div>
            </div>

            {/* ê±°ì£¼ì§€ì—­ */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                ê±°ì£¼ì§€ì—­ <span className="text-red-500">*</span>
              </label>
              <LocationPicker
                address={residence}
                onLocationSelect={handleResidenceSelect}
              />
            </div>

            {/* ì€í–‰ ì •ë³´ */}
            <div className="pt-4 border-t">
              <p className="text-sm font-medium text-gray-700 mb-3">
                ê¸‰ì—¬ ìˆ˜ë ¹ ê³„ì¢Œ <span className="text-red-500">*</span>
              </p>
              <div className="space-y-3">
                <input
                  type="text"
                  value={bankName}
                  onChange={(e) => setBankName(e.target.value)}
                  placeholder="ì€í–‰ëª… (ì˜ˆ: ì‹ í•œì€í–‰)"
                  className="input"
                />
                <input
                  type="text"
                  value={bankAccount}
                  onChange={(e) => setBankAccount(e.target.value)}
                  placeholder="ê³„ì¢Œë²ˆí˜¸"
                  className="input"
                />
              </div>
            </div>

            <div className="flex gap-3 pt-4">
              <button
                onClick={() => setStep(1)}
                className="flex-1 py-3 bg-gray-100 text-gray-700 rounded-xl font-medium"
              >
                ì´ì „
              </button>
              <button
                onClick={handleRegister}
                disabled={loading}
                className="flex-1 btn-primary"
              >
                {loading ? 'ê°€ì… ì¤‘...' : 'ê°€ì… ì™„ë£Œ'}
              </button>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
