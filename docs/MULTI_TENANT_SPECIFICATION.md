# WorkProof Chain v2 - 멀티테넌트 플랫폼 기획서

## Protected Shared Pool Model (보호형 공유 인력풀)

**버전**: 2.0
**작성일**: 2026-01-26
**상태**: 기획 완료

---

## 목차

1. [서비스 요약](#1-서비스-요약)
2. [전체 구조 다이어그램](#2-전체-구조-다이어그램)
3. [멀티테넌트 구조](#3-멀티테넌트-구조)
4. [근로자 데이터 구조](#4-근로자-데이터-구조)
5. [보호형 공유 인력풀 모델](#5-보호형-공유-인력풀-모델)
6. [정보 공개 단계표](#6-정보-공개-단계표)
7. [매칭 플로우](#7-매칭-플로우)
8. [보안 설계](#8-보안-설계)
9. [DB 구조](#9-db-구조)
10. [API 권한 설계](#10-api-권한-설계)
11. [요금제 표](#11-요금제-표)
12. [MVP 범위](#12-mvp-범위)
13. [확장 로드맵](#13-확장-로드맵)

---

## 1. 서비스 요약

### 1.1 핵심 가치 제안

> **"인력 유동성은 확보하되, 업체의 인력 자산은 보호하는 HR SaaS"**

WorkProof Chain v2는 다음 세 이해관계자의 니즈를 동시에 충족하는 멀티테넌트 HR 플랫폼입니다:

| 이해관계자 | 핵심 니즈 | 솔루션 |
|-----------|----------|--------|
| **업체 (Organization)** | "우리가 키운 인력을 빼앗기면 안 돼" | 보호 모드(protected) 기본 적용 |
| **근로자 (Worker)** | "더 좋은 기회가 있으면 이동하고 싶어" | 자발적 지원 및 공개 전환 옵션 |
| **플랫폼 (WorkProof)** | "네트워크 효과를 위해 풀은 커야 해" | 공유 인력풀 + 단계별 정보 공개 |

### 1.2 서비스 특징

```
┌─────────────────────────────────────────────────────────────────┐
│                    WorkProof Chain v2                           │
├─────────────────────────────────────────────────────────────────┤
│  ✅ 멀티테넌트 SaaS      - 여러 업체가 하나의 플랫폼 공유       │
│  ✅ 공유 인력풀          - 근로자는 전체 플랫폼에 1회 가입      │
│  ✅ 보호형 모델          - 업체별 인력 자산 보호                │
│  ✅ 단계별 정보 공개     - 매칭 진행에 따라 개인정보 공개       │
│  ✅ 블록체인 증명        - 근로 이력 위변조 불가능              │
│  ✅ 투명한 신뢰점수      - 객관적 평가 기반 인력 검증           │
└─────────────────────────────────────────────────────────────────┘
```

### 1.3 비즈니스 모델

- **수익원**: 월정액 구독료 (요금제별 차등)
- **핵심 지표**: 업체 수, 근로자 수, 매칭 건수, 재사용률
- **경쟁 우위**: 블록체인 기반 신뢰 + 보호형 공유 모델

---

## 2. 전체 구조 다이어그램

### 2.1 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           클라이언트 계층                                │
├───────────────┬───────────────┬───────────────┬─────────────────────────┤
│  Admin Bot    │  Worker Bot   │  Web Admin    │  Web Worker             │
│  (Telegram)   │  (Telegram)   │  (React)      │  (React)                │
│  업체 관리자용 │  근로자용      │  업체 대시보드 │  근로자 대시보드         │
└───────┬───────┴───────┬───────┴───────┬───────┴───────┬─────────────────┘
        │               │               │               │
        └───────────────┴───────┬───────┴───────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         API Gateway (FastAPI)                           │
│                                                                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │ Auth        │  │ Org         │  │ Worker      │  │ Event       │    │
│  │ Service     │  │ Service     │  │ Service     │  │ Service     │    │
│  │             │  │             │  │             │  │             │    │
│  │ - JWT 발급  │  │ - 업체 CRUD │  │ - 프로필    │  │ - 이벤트    │    │
│  │ - 권한 체크 │  │ - 멤버 관리 │  │ - 매칭      │  │ - 지원/제안 │    │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │
│                                                                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │ Attendance  │  │ Payroll     │  │ Blockchain  │  │ Analytics   │    │
│  │ Service     │  │ Service     │  │ Service     │  │ Service     │    │
│  │             │  │             │  │             │  │             │    │
│  │ - 출퇴근    │  │ - 급여 계산 │  │ - 온체인    │  │ - 통계      │    │
│  │ - QR/코드   │  │ - 내보내기  │  │ - 해시 기록 │  │ - 리포트    │    │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │
└─────────────────────────────────┬───────────────────────────────────────┘
                                  │
                    ┌─────────────┼─────────────┐
                    │             │             │
                    ▼             ▼             ▼
┌─────────────────────┐  ┌──────────────┐  ┌─────────────────────┐
│     PostgreSQL      │  │   Redis      │  │   Polygon Chain     │
│                     │  │              │  │                     │
│ ┌─────────────────┐ │  │ - 세션 캐시  │  │ - WorkLogRegistry   │
│ │ organizations   │ │  │ - Rate Limit │  │ - WorkProofToken    │
│ │ org_members     │ │  │ - Job Queue  │  │                     │
│ │ workers_public  │ │  └──────────────┘  │ (Amoy Testnet /     │
│ │ workers_private │ │                    │  Mainnet)           │
│ │ events          │ │                    └─────────────────────┘
│ │ applications    │ │
│ │ attendance      │ │
│ │ access_logs     │ │
│ └─────────────────┘ │
│                     │
│ + Row Level Security│
└─────────────────────┘
```

### 2.2 데이터 흐름

```
┌──────────────────────────────────────────────────────────────────────────┐
│                            데이터 흐름도                                  │
└──────────────────────────────────────────────────────────────────────────┘

[근로자 가입]
     │
     ▼
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ Worker Bot  │────▶│ workers_    │────▶│ workers_    │
│ 회원가입    │     │ public      │     │ private     │
└─────────────┘     │ (공개정보)  │     │ (개인정보)  │
                    │             │     │ 암호화 저장 │
                    │ home_org_id │     └─────────────┘
                    │ = 가입 업체 │
                    │             │
                    │ visibility  │
                    │ = protected │
                    └─────────────┘
                          │
                          ▼
           ┌──────────────────────────────┐
           │     Protected Shared Pool    │
           │                              │
           │  ┌────────┐  ┌────────┐     │
           │  │ Org A  │  │ Org B  │     │
           │  │ 소속   │  │ 검색   │     │
           │  │ 근로자 │  │ 불가   │     │
           │  └────────┘  └────────┘     │
           │                              │
           │  근로자가 직접 지원 시에만   │
           │  타 업체에 Level 1 정보 공개 │
           └──────────────────────────────┘
```

---

## 3. 멀티테넌트 구조

### 3.1 테넌트 격리 전략

```
┌─────────────────────────────────────────────────────────────────┐
│                      테넌트 격리 모델                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    공유 계층 (Shared)                    │   │
│  │                                                         │   │
│  │  workers_public    - 모든 업체가 검색 가능 (조건부)     │   │
│  │  workers_private   - RLS로 접근 제어                    │   │
│  │  platform_config   - 플랫폼 공통 설정                   │   │
│  │  trust_scores      - 신뢰점수 (공개)                    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    격리 계층 (Isolated by org_id)        │   │
│  │                                                         │   │
│  │  organizations     - 업체 정보                          │   │
│  │  org_members       - 업체별 관리자 계정                 │   │
│  │  events            - 업체별 이벤트                      │   │
│  │  applications      - 업체별 지원 내역                   │   │
│  │  attendance        - 업체별 출퇴근 기록                 │   │
│  │  payroll_exports   - 업체별 급여 내보내기               │   │
│  │  access_logs       - 업체별 접근 로그                   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 organizations 테이블

| 컬럼명 | 타입 | 설명 |
|--------|------|------|
| `id` | SERIAL PK | 업체 고유 ID |
| `name` | VARCHAR(100) | 업체명 |
| `business_number` | VARCHAR(20) | 사업자등록번호 |
| `representative` | VARCHAR(50) | 대표자명 |
| `contact_email` | VARCHAR(100) | 대표 이메일 |
| `contact_phone` | VARCHAR(20) | 대표 연락처 |
| `address` | TEXT | 사업장 주소 |
| `plan` | VARCHAR(20) | 요금제 (free/basic/pro/enterprise) |
| `plan_expires_at` | TIMESTAMP | 요금제 만료일 |
| `settings` | JSONB | 업체별 설정 |
| `created_at` | TIMESTAMP | 가입일 |
| `is_active` | BOOLEAN | 활성화 여부 |

**settings JSONB 구조:**
```json
{
  "allow_worker_proposal": true,
  "auto_approve_applications": false,
  "require_photo_checkin": true,
  "default_hourly_rate": 15000,
  "notification_channels": ["telegram", "email"],
  "working_regions": ["서울", "경기"]
}
```

### 3.3 org_members 테이블

| 컬럼명 | 타입 | 설명 |
|--------|------|------|
| `id` | SERIAL PK | 멤버 고유 ID |
| `org_id` | INTEGER FK | 소속 업체 |
| `email` | VARCHAR(100) | 로그인 이메일 |
| `password_hash` | VARCHAR(255) | 비밀번호 해시 |
| `name` | VARCHAR(50) | 이름 |
| `role` | VARCHAR(20) | 역할 (owner/admin/manager/viewer) |
| `telegram_id` | BIGINT | 텔레그램 연동 ID |
| `permissions` | JSONB | 세부 권한 |
| `last_login_at` | TIMESTAMP | 마지막 로그인 |
| `is_active` | BOOLEAN | 활성화 여부 |

**role 권한 체계:**

| 역할 | 설명 | 권한 |
|------|------|------|
| `owner` | 업체 소유자 | 모든 권한 + 결제 관리 + 업체 삭제 |
| `admin` | 관리자 | 멤버 관리 + 설정 변경 + 모든 이벤트 관리 |
| `manager` | 매니저 | 이벤트 생성/관리 + 근로자 정보 열람 |
| `viewer` | 뷰어 | 조회만 가능 |

### 3.4 JWT 토큰 구조

```json
{
  "sub": "member_123",
  "type": "org_member",
  "org_id": 1,
  "role": "admin",
  "permissions": ["events:write", "workers:read", "payroll:export"],
  "iat": 1706000000,
  "exp": 1706604800
}
```

**근로자용 JWT:**
```json
{
  "sub": "worker_456",
  "type": "worker",
  "worker_id": 456,
  "home_org_id": 1,
  "visibility_mode": "protected",
  "iat": 1706000000,
  "exp": 1706604800
}
```

---

## 4. 근로자 데이터 구조

### 4.1 이중 분리 원칙

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        근로자 데이터 이중 분리                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌────────────────────────────┐    ┌────────────────────────────┐      │
│  │     workers_public         │    │     workers_private        │      │
│  │     (공개 프로필)          │    │     (개인정보 금고)        │      │
│  ├────────────────────────────┤    ├────────────────────────────┤      │
│  │                            │    │                            │      │
│  │ • 가명 ID                  │    │ • 실명                     │      │
│  │ • 활동 지역                │    │ • 연락처                   │      │
│  │ • 가능 업무 유형           │    │ • 생년월일                 │      │
│  │ • 신뢰점수                 │    │ • 계좌정보                 │      │
│  │ • 총 근무 횟수             │    │ • 주민등록번호             │      │
│  │ • 평균 평점                │    │ • 사진                     │      │
│  │ • 노쇼율/지각율            │    │ • 계약서                   │      │
│  │                            │    │ • 텔레그램 ID              │      │
│  │ ✅ 검색 가능 (조건부)      │    │ ❌ 매칭 확정 후만 공개     │      │
│  │                            │    │                            │      │
│  └────────────────────────────┘    └────────────────────────────┘      │
│                                                                         │
│  연결: workers_public.id = workers_private.worker_id (1:1)             │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.2 workers_public 테이블

| 컬럼명 | 타입 | 설명 |
|--------|------|------|
| `id` | SERIAL PK | 근로자 고유 ID |
| `public_uid` | VARCHAR(20) | 공개용 가명 ID (예: WP-A7X9K2) |
| `display_name` | VARCHAR(20) | 표시 이름 (예: 김*수) |
| `region` | VARCHAR(50) | 주 활동 지역 |
| `sub_regions` | VARCHAR[] | 세부 활동 지역 배열 |
| `work_types` | VARCHAR[] | 가능 업무 유형 |
| `trust_score` | DECIMAL(3,2) | 신뢰점수 (0.00~5.00) |
| `total_jobs` | INTEGER | 총 근무 횟수 |
| `total_hours` | INTEGER | 총 근무 시간 |
| `avg_rating` | DECIMAL(2,1) | 평균 평점 (1.0~5.0) |
| `no_show_rate` | DECIMAL(4,3) | 노쇼율 (0.000~1.000) |
| `late_rate` | DECIMAL(4,3) | 지각율 |
| `home_org_id` | INTEGER FK | 최초 가입 업체 |
| `visibility_mode` | VARCHAR(20) | protected / public |
| `is_available` | BOOLEAN | 현재 구직 중 여부 |
| `last_active_at` | TIMESTAMP | 마지막 활동 시간 |
| `created_at` | TIMESTAMP | 가입일 |

**work_types 예시:**
```sql
ARRAY['행사보조', '전시도우미', '판촉', '서빙', '주방보조', '청소', '물류']
```

### 4.3 workers_private 테이블

| 컬럼명 | 타입 | 설명 |
|--------|------|------|
| `worker_id` | INTEGER PK/FK | workers_public.id 참조 |
| `real_name` | VARCHAR(50) | 실명 |
| `phone` | VARCHAR(20) | 연락처 (암호화) |
| `phone_hash` | VARCHAR(64) | 연락처 해시 (중복 체크용) |
| `email` | VARCHAR(100) | 이메일 |
| `birthdate` | DATE | 생년월일 |
| `gender` | VARCHAR(10) | 성별 |
| `ssn_encrypted` | BYTEA | 주민등록번호 (AES 암호화) |
| `bank_name` | VARCHAR(50) | 은행명 |
| `bank_account` | VARCHAR(50) | 계좌번호 (암호화) |
| `bank_holder` | VARCHAR(50) | 예금주 |
| `address` | TEXT | 주소 |
| `emergency_contact` | VARCHAR(50) | 비상연락처 |
| `telegram_id` | BIGINT | 텔레그램 ID |
| `profile_photo_url` | TEXT | 프로필 사진 URL |
| `id_card_verified` | BOOLEAN | 신분증 인증 여부 |
| `id_card_verified_at` | TIMESTAMP | 신분증 인증 일시 |
| `updated_at` | TIMESTAMP | 정보 수정일 |

### 4.4 신뢰점수 계산 공식

```
trust_score = (
    base_score                           # 기본 3.0
    + (total_jobs * 0.02)                # 경력 가점 (최대 +1.0)
    + (avg_rating - 3.0) * 0.5           # 평점 반영
    - (no_show_rate * 3.0)               # 노쇼 페널티
    - (late_rate * 1.0)                  # 지각 페널티
    + (id_verified ? 0.3 : 0)            # 신분증 인증 가점
    + (on_chain_records * 0.01)          # 블록체인 기록 가점
)

# 범위: 0.00 ~ 5.00
```

---

## 5. 보호형 공유 인력풀 모델

### 5.1 모델 개요

```
┌─────────────────────────────────────────────────────────────────────────┐
│              Protected Shared Pool Model (보호형 공유 인력풀)           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  핵심 원칙:                                                            │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 1. 근로자는 플랫폼 전체에서 1개의 계정만 가짐                   │   │
│  │ 2. 최초 가입 업체(home_org)가 해당 근로자를 기본적으로 "보호"   │   │
│  │ 3. 보호 상태에서는 타 업체 검색/제안 대상에서 제외              │   │
│  │ 4. 근로자 본인 의지로만 타 업체와 연결 가능                     │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  visibility_mode 상태:                                                 │
│                                                                         │
│  ┌─────────────────────┐          ┌─────────────────────┐              │
│  │     PROTECTED       │          │       PUBLIC        │              │
│  │     (기본값)        │          │     (선택적)        │              │
│  ├─────────────────────┤          ├─────────────────────┤              │
│  │                     │          │                     │              │
│  │ • 타 업체 검색 ❌   │          │ • 전체 업체 검색 ✅ │              │
│  │ • 타 업체 제안 ❌   │          │ • 전체 업체 제안 ✅ │              │
│  │ • 본인 지원만 ✅    │          │ • 헤드헌팅 가능 ✅  │              │
│  │                     │  ──────▶ │                     │              │
│  │ home_org에 정보     │  근로자  │ 모든 업체에 정보    │              │
│  │ 완전 공개           │  설정    │ 단계별 공개         │              │
│  │                     │  변경    │                     │              │
│  └─────────────────────┘          └─────────────────────┘              │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5.2 상태별 접근 권한

#### PROTECTED 상태 (기본)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     visibility_mode = 'protected'                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Home Organization (최초 가입 업체)                                     │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ ✅ workers_public 전체 열람                                     │   │
│  │ ✅ workers_private 전체 열람                                    │   │
│  │ ✅ 직접 이벤트 배정 가능                                        │   │
│  │ ✅ 보호 해제 권한 (근로자 동의 필요)                            │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  Other Organizations (타 업체)                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ ❌ 검색 결과에 노출 안 됨                                       │   │
│  │ ❌ 근로자 제안 불가                                             │   │
│  │ ❌ 개인정보 접근 불가                                           │   │
│  │                                                                 │   │
│  │ 예외: 근로자가 직접 지원한 경우                                 │   │
│  │ ├── Level 0: public_uid, region, trust_score 등                │   │
│  │ ├── Level 1: display_name, work_types (지원 수락 시)           │   │
│  │ └── Level 2: real_name, phone (근무 확정 시)                   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### PUBLIC 상태

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      visibility_mode = 'public'                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  All Organizations                                                      │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ ✅ 검색 결과에 노출                                             │   │
│  │ ✅ 근로자 제안 가능 (제안 기능 활성화된 요금제)                 │   │
│  │                                                                 │   │
│  │ 정보 공개 수준은 매칭 단계에 따름:                              │   │
│  │ ├── Level 0: 검색/목록 (public_uid, scores)                    │   │
│  │ ├── Level 1: 지원 수락 (display_name, work_types)              │   │
│  │ └── Level 2: 근무 확정 (real_name, phone, bank)                │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  Home Organization                                                      │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ ✅ 여전히 전체 정보 접근 가능                                   │   │
│  │ ⚠️ 근로자가 타 업체와 매칭되어도 알림 받음 (선택적)            │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5.3 보호 해제 조건

| 조건 | 설명 | 결과 |
|------|------|------|
| **근로자 본인 설정 변경** | 설정에서 visibility_mode를 public으로 변경 | 전체 공개 |
| **근로자 직접 지원** | protected 상태에서 타 업체 이벤트에 지원 | 해당 업체에만 단계별 공개 |
| **Home Org 보호 해제** | 원 소속 업체가 보호를 해제 | 근로자 동의 후 공개 전환 |
| **Home Org 비활성화** | 원 소속 업체가 서비스 해지 | 자동으로 public 전환 |
| **장기 미활동** | 6개월 이상 home_org 이벤트 미참여 | 공개 전환 제안 알림 |

### 5.4 worker_visibility_settings 테이블

| 컬럼명 | 타입 | 설명 |
|--------|------|------|
| `worker_id` | INTEGER PK/FK | 근로자 ID |
| `visibility_mode` | VARCHAR(20) | protected / public |
| `allow_proposals` | BOOLEAN | 업체 제안 수신 허용 |
| `blocked_org_ids` | INTEGER[] | 차단한 업체 목록 |
| `preferred_org_ids` | INTEGER[] | 선호 업체 목록 |
| `home_org_released` | BOOLEAN | Home Org가 보호 해제했는지 |
| `released_at` | TIMESTAMP | 보호 해제 일시 |
| `release_reason` | VARCHAR(100) | 해제 사유 |

---

## 6. 정보 공개 단계표

### 6.1 단계별 공개 필드

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        정보 공개 3단계 모델                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Level 0                Level 1                 Level 2                 │
│  검색/목록               지원 수락               근무 확정               │
│  ─────────              ─────────               ─────────               │
│                                                                         │
│  ┌───────────┐          ┌───────────┐          ┌───────────┐           │
│  │ public_uid│    +     │display_   │    +     │ real_name │           │
│  │ region    │          │  name     │          │ phone     │           │
│  │ trust_    │          │ work_types│          │ email     │           │
│  │  score    │          │ total_jobs│          │ bank_     │           │
│  │ avg_rating│          │ profile_  │          │  account  │           │
│  │ no_show_  │          │  photo    │          │ ssn (급여 │           │
│  │  rate     │          │ (썸네일)  │          │  신고용)  │           │
│  │ late_rate │          │           │          │ address   │           │
│  │ is_       │          │           │          │ contracts │           │
│  │ available │          │           │          │           │           │
│  └───────────┘          └───────────┘          └───────────┘           │
│                                                                         │
│   ▲                      ▲                      ▲                       │
│   │                      │                      │                       │
│   │                      │                      │                       │
│  모든 업체              지원 수락 또는         출석 확정                │
│  (public 모드           제안 수락 후           (CONFIRMED) 후           │
│   검색 시)                                                              │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 6.2 상세 공개 정보표

| 필드 | Level 0 | Level 1 | Level 2 | 비고 |
|------|:-------:|:-------:|:-------:|------|
| **공개 프로필 (workers_public)** |
| public_uid | ✅ | ✅ | ✅ | 가명 ID |
| display_name | ❌ | ✅ | ✅ | 마스킹된 이름 |
| region | ✅ | ✅ | ✅ | |
| sub_regions | ❌ | ✅ | ✅ | |
| work_types | ❌ | ✅ | ✅ | |
| trust_score | ✅ | ✅ | ✅ | |
| total_jobs | ✅ | ✅ | ✅ | |
| avg_rating | ✅ | ✅ | ✅ | |
| no_show_rate | ✅ | ✅ | ✅ | |
| late_rate | ✅ | ✅ | ✅ | |
| is_available | ✅ | ✅ | ✅ | |
| **개인정보 (workers_private)** |
| real_name | ❌ | ❌ | ✅ | |
| phone | ❌ | ❌ | ✅ | |
| email | ❌ | ❌ | ✅ | |
| birthdate | ❌ | ❌ | ✅ | |
| bank_account | ❌ | ❌ | ✅ | 급여 지급용 |
| ssn_encrypted | ❌ | ❌ | ✅* | 급여 신고 시만 |
| address | ❌ | ❌ | ✅ | |
| profile_photo | ❌ | ✅ (썸네일) | ✅ (원본) | |
| telegram_id | ❌ | ❌ | ❌ | 시스템용 |

### 6.3 접근 조건 매트릭스

| 요청 업체 | 근로자 상태 | 관계 | 접근 레벨 |
|-----------|-------------|------|-----------|
| Home Org | protected | 소속 | Level 2 (전체) |
| Home Org | public | 소속 | Level 2 (전체) |
| 타 업체 | protected | 없음 | ❌ 접근 불가 |
| 타 업체 | protected | 직접 지원 | Level 0 → 1 → 2 (단계별) |
| 타 업체 | public | 없음 | Level 0 |
| 타 업체 | public | 제안 수락 | Level 1 |
| 타 업체 | public | 근무 확정 | Level 2 |

---

## 7. 매칭 플로우

### 7.1 근로자 지원형 (기본 모델)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    근로자 지원형 매칭 플로우                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────┐                                                           │
│  │  업체   │                                                           │
│  │         │                                                           │
│  │ 이벤트  │                                                           │
│  │ 등록    │                                                           │
│  └────┬────┘                                                           │
│       │                                                                 │
│       ▼                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐       │
│  │                    이벤트 공개                               │       │
│  │                                                             │       │
│  │  • 이벤트명, 날짜, 장소, 시급                              │       │
│  │  • 필요 인원, 요구 조건                                    │       │
│  │  • 모든 근로자에게 노출 (visibility 무관)                  │       │
│  └─────────────────────────────────────────────────────────────┘       │
│       │                                                                 │
│       │  근로자 검색/확인                                              │
│       ▼                                                                 │
│  ┌─────────┐                                                           │
│  │ 근로자  │ ◀─────── protected 상태여도 이벤트 열람 가능              │
│  │         │                                                           │
│  │ 지원    │ ──────▶ application 레코드 생성                          │
│  │         │          status = 'PENDING'                               │
│  │         │          visibility_level = 0                             │
│  └────┬────┘                                                           │
│       │                                                                 │
│       │  업체에서 지원자 목록 확인                                     │
│       │  (Level 0 정보만 보임: public_uid, scores)                     │
│       ▼                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐       │
│  │                    업체 검토                                 │       │
│  │                                                             │       │
│  │  APPROVE ──▶ status='APPROVED', level=1                    │       │
│  │              (display_name, work_types 공개)                │       │
│  │                                                             │       │
│  │  REJECT ───▶ status='REJECTED'                             │       │
│  │              (근로자에게 알림)                              │       │
│  └─────────────────────────────────────────────────────────────┘       │
│       │                                                                 │
│       │  APPROVED 시                                                   │
│       ▼                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐       │
│  │                    근무 확정                                 │       │
│  │                                                             │       │
│  │  업체: CONFIRM ──▶ status='CONFIRMED', level=2             │       │
│  │                    (real_name, phone, bank 공개)            │       │
│  │                    attendance 레코드 생성                   │       │
│  │                                                             │       │
│  │  또는                                                       │       │
│  │  업체: CANCEL ───▶ status='CANCELLED'                      │       │
│  └─────────────────────────────────────────────────────────────┘       │
│       │                                                                 │
│       │  CONFIRMED 시                                                  │
│       ▼                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐       │
│  │                    근무 수행                                 │       │
│  │                                                             │       │
│  │  1. 출근 체크 (QR/코드)                                    │       │
│  │  2. 퇴근 체크                                              │       │
│  │  3. 근무 완료 ──▶ 블록체인 기록                            │       │
│  │  4. 상호 평가                                              │       │
│  │  5. 급여 정산                                              │       │
│  └─────────────────────────────────────────────────────────────┘       │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**applications 상태 전이:**
```
PENDING → APPROVED → CONFIRMED → COMPLETED
              ↓          ↓           ↓
          REJECTED    CANCELLED   NO_SHOW
```

### 7.2 업체 제안형 (확장 모델)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    업체 제안형 매칭 플로우                               │
│                    (Pro/Enterprise 요금제)                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────┐                                                           │
│  │  업체   │                                                           │
│  │         │                                                           │
│  │ 인력풀  │                                                           │
│  │ 검색    │                                                           │
│  └────┬────┘                                                           │
│       │                                                                 │
│       ▼                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐       │
│  │                    검색 필터링                               │       │
│  │                                                             │       │
│  │  visibility_mode = 'public' 인 근로자만 검색               │       │
│  │  + region, work_types, trust_score 필터                    │       │
│  │  + blocked_org_ids에 현재 업체 없음                        │       │
│  │  + allow_proposals = true                                  │       │
│  │                                                             │       │
│  │  결과: Level 0 정보 표시                                   │       │
│  └─────────────────────────────────────────────────────────────┘       │
│       │                                                                 │
│       │  적합한 근로자 발견                                            │
│       ▼                                                                 │
│  ┌─────────┐                                                           │
│  │  업체   │                                                           │
│  │         │                                                           │
│  │ 제안    │ ──────▶ proposal 레코드 생성                             │
│  │ 발송    │          status = 'SENT'                                  │
│  │         │          (월 제안 횟수 차감)                              │
│  └────┬────┘                                                           │
│       │                                                                 │
│       │  근로자에게 알림                                               │
│       ▼                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐       │
│  │                    근로자 검토                               │       │
│  │                                                             │       │
│  │  • 이벤트 정보 확인                                        │       │
│  │  • 업체 정보 확인 (업체명, 평점, 후기)                     │       │
│  │                                                             │       │
│  │  ACCEPT ──▶ status='ACCEPTED'                              │       │
│  │             Level 1 정보 공개                              │       │
│  │             application 자동 생성 (status='APPROVED')      │       │
│  │                                                             │       │
│  │  REJECT ──▶ status='REJECTED'                              │       │
│  │             (향후 3개월 해당 업체 제안 차단 옵션)          │       │
│  │                                                             │       │
│  │  BLOCK ───▶ blocked_org_ids에 추가                        │       │
│  │             영구 제안 차단                                 │       │
│  └─────────────────────────────────────────────────────────────┘       │
│       │                                                                 │
│       │  ACCEPT 시, 이후 플로우는 지원형과 동일                        │
│       ▼                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐       │
│  │  CONFIRM → 근무 수행 → 평가 → 급여 정산                    │       │
│  └─────────────────────────────────────────────────────────────┘       │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 7.3 매칭 방식 비교

| 항목 | 근로자 지원형 | 업체 제안형 |
|------|--------------|-------------|
| **진입 장벽** | 낮음 | 높음 (Pro 이상) |
| **보호 모드 영향** | 없음 (지원은 자유) | protected 검색 불가 |
| **정보 공개 시점** | 지원 시점부터 | 제안 수락 시점부터 |
| **업체 업무량** | 지원자 검토 필요 | 직접 선별 가능 |
| **근로자 경험** | 능동적 | 수동적 (제안 대기) |
| **MVP 포함** | ✅ 필수 | ❌ Phase 2 |
| **수익화** | 기본 기능 | 유료 기능 |

### 7.4 MVP 권장

**Phase 1 (MVP):**
- 근로자 지원형만 구현
- protected/public 모드 구현
- 3단계 정보 공개 구현

**Phase 2:**
- 업체 제안형 추가
- 제안 횟수 쿼터 관리
- 차단/선호 업체 기능

---

## 8. 보안 설계

### 8.1 개인정보 보호 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        개인정보 보호 계층                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                     Application Layer                           │   │
│  │                                                                 │   │
│  │  • JWT 토큰 검증                                               │   │
│  │  • org_id / worker_id 확인                                     │   │
│  │  • visibility_mode 체크                                        │   │
│  │  • application.status 체크                                     │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                  │                                      │
│                                  ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                     Row Level Security (RLS)                    │   │
│  │                                                                 │   │
│  │  PostgreSQL RLS 정책:                                          │   │
│  │  • events: org_id = current_setting('app.org_id')              │   │
│  │  • applications: org_id = current_setting('app.org_id')        │   │
│  │  • attendance: org_id = current_setting('app.org_id')          │   │
│  │  • workers_private: 별도 접근 함수 사용                        │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                  │                                      │
│                                  ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                     Data Encryption                             │   │
│  │                                                                 │   │
│  │  • phone: AES-256-GCM 암호화                                   │   │
│  │  • ssn_encrypted: AES-256-GCM 암호화                           │   │
│  │  • bank_account: AES-256-GCM 암호화                            │   │
│  │  • 암호화 키: AWS KMS 또는 HashiCorp Vault 관리                │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                  │                                      │
│                                  ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                     Audit Logging                               │   │
│  │                                                                 │   │
│  │  • 모든 개인정보 접근 기록                                     │   │
│  │  • 접근 주체, 대상, 시간, IP, 사유                             │   │
│  │  • 이상 접근 패턴 탐지                                         │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 8.2 access_logs 테이블

| 컬럼명 | 타입 | 설명 |
|--------|------|------|
| `id` | SERIAL PK | 로그 ID |
| `org_id` | INTEGER | 접근 업체 |
| `member_id` | INTEGER | 접근 멤버 |
| `worker_id` | INTEGER | 열람 대상 근로자 |
| `access_type` | VARCHAR(30) | 접근 유형 |
| `access_level` | INTEGER | 공개 레벨 (0/1/2) |
| `fields_accessed` | VARCHAR[] | 접근한 필드 목록 |
| `reason` | VARCHAR(100) | 접근 사유 |
| `ip_address` | INET | IP 주소 |
| `user_agent` | TEXT | 브라우저/앱 정보 |
| `accessed_at` | TIMESTAMP | 접근 시간 |

**access_type 값:**
- `SEARCH_LIST`: 검색 결과 목록
- `VIEW_PROFILE`: 프로필 상세 조회
- `VIEW_PRIVATE`: 개인정보 조회
- `EXPORT_DATA`: 데이터 내보내기
- `DOWNLOAD_PHOTO`: 사진 다운로드

### 8.3 접근 쿼터 관리

```python
# 요금제별 월간 쿼터
PLAN_QUOTAS = {
    'free': {
        'private_views': 10,      # 개인정보 열람
        'proposals': 0,           # 제안 발송
        'exports': 1,             # 급여 내보내기
    },
    'basic': {
        'private_views': 50,
        'proposals': 0,
        'exports': 5,
    },
    'pro': {
        'private_views': 200,
        'proposals': 30,
        'exports': 20,
    },
    'enterprise': {
        'private_views': -1,      # 무제한
        'proposals': -1,
        'exports': -1,
    }
}
```

### 8.4 org_quotas 테이블

| 컬럼명 | 타입 | 설명 |
|--------|------|------|
| `org_id` | INTEGER PK/FK | 업체 ID |
| `quota_month` | VARCHAR(7) | YYYY-MM |
| `private_views_used` | INTEGER | 개인정보 열람 사용량 |
| `private_views_limit` | INTEGER | 개인정보 열람 한도 |
| `proposals_used` | INTEGER | 제안 발송 사용량 |
| `proposals_limit` | INTEGER | 제안 발송 한도 |
| `exports_used` | INTEGER | 내보내기 사용량 |
| `exports_limit` | INTEGER | 내보내기 한도 |

### 8.5 RLS 정책 예시

```sql
-- events 테이블 RLS
ALTER TABLE events ENABLE ROW LEVEL SECURITY;

CREATE POLICY events_org_isolation ON events
    USING (org_id = current_setting('app.org_id')::INTEGER);

-- workers_private 접근 함수
CREATE OR REPLACE FUNCTION can_access_worker_private(
    p_org_id INTEGER,
    p_worker_id INTEGER,
    p_required_level INTEGER
) RETURNS BOOLEAN AS $$
DECLARE
    v_home_org_id INTEGER;
    v_visibility VARCHAR(20);
    v_app_level INTEGER;
BEGIN
    -- 근로자 정보 조회
    SELECT home_org_id, visibility_mode
    INTO v_home_org_id, v_visibility
    FROM workers_public
    WHERE id = p_worker_id;

    -- Home Org는 항상 접근 가능
    IF v_home_org_id = p_org_id THEN
        RETURN TRUE;
    END IF;

    -- protected 상태면 타 업체 접근 불가
    IF v_visibility = 'protected' THEN
        -- 단, 지원/제안 관계가 있으면 해당 레벨까지 허용
        SELECT CASE status
            WHEN 'PENDING' THEN 0
            WHEN 'APPROVED' THEN 1
            WHEN 'CONFIRMED' THEN 2
            WHEN 'COMPLETED' THEN 2
            ELSE -1
        END INTO v_app_level
        FROM applications
        WHERE org_id = p_org_id AND worker_id = p_worker_id
        ORDER BY created_at DESC
        LIMIT 1;

        RETURN COALESCE(v_app_level, -1) >= p_required_level;
    END IF;

    -- public 상태면 application 레벨 체크
    SELECT CASE status
        WHEN 'PENDING' THEN 0
        WHEN 'APPROVED' THEN 1
        WHEN 'CONFIRMED' THEN 2
        WHEN 'COMPLETED' THEN 2
        ELSE 0
    END INTO v_app_level
    FROM applications
    WHERE org_id = p_org_id AND worker_id = p_worker_id
    ORDER BY created_at DESC
    LIMIT 1;

    RETURN COALESCE(v_app_level, 0) >= p_required_level;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### 8.6 이상 접근 탐지

```python
# 이상 접근 패턴 정의
ANOMALY_RULES = {
    'high_frequency': {
        'description': '1시간 내 50건 이상 개인정보 조회',
        'threshold': 50,
        'window_minutes': 60,
        'action': 'alert_admin'
    },
    'off_hours_access': {
        'description': '야간(22시-06시) 대량 조회',
        'threshold': 20,
        'hours': (22, 6),
        'action': 'require_2fa'
    },
    'bulk_export': {
        'description': '전체 근로자 일괄 조회 시도',
        'threshold': 100,
        'window_minutes': 10,
        'action': 'block_and_alert'
    },
    'unusual_ip': {
        'description': '새로운 IP에서 대량 접근',
        'threshold': 30,
        'window_minutes': 30,
        'action': 'require_verification'
    }
}
```

---

## 9. DB 구조

### 9.1 ERD 개요

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            ERD (Entity Relationship Diagram)            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  organizations ◀──────┬───────── org_members                           │
│       │               │                                                 │
│       │               ├───────── events                                │
│       │               │              │                                  │
│       │               │              └────────── attendance            │
│       │               │              │                                  │
│       │               │              └────────── applications ─────┐   │
│       │               │                                            │   │
│       │               ├───────── proposals ──────────────────────┐ │   │
│       │               │                                          │ │   │
│       │               ├───────── payroll_exports                 │ │   │
│       │               │                                          │ │   │
│       │               ├───────── access_logs                     │ │   │
│       │               │                                          │ │   │
│       │               └───────── org_quotas                      │ │   │
│       │                                                          │ │   │
│       └───────────────────── (home_org_id) ──────────────────┐   │ │   │
│                                                              │   │ │   │
│                                                              ▼   │ │   │
│  workers_public ◀───────────── workers_private               │   │ │   │
│       │                              │                       │   │ │   │
│       │                              │                       │   │ │   │
│       └──────────────────────────────┴───────────────────────┘◀──┴─┘   │
│                                      │                                  │
│                                      │                                  │
│  worker_visibility_settings ◀────────┘                                 │
│                                                                         │
│  chain_logs (블록체인 기록)                                            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 9.2 전체 테이블 목록

#### 업체 관련

```sql
-- organizations: 업체 정보
CREATE TABLE organizations (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    business_number VARCHAR(20) UNIQUE,
    representative VARCHAR(50),
    contact_email VARCHAR(100) NOT NULL,
    contact_phone VARCHAR(20),
    address TEXT,
    plan VARCHAR(20) DEFAULT 'free',
    plan_expires_at TIMESTAMP,
    settings JSONB DEFAULT '{}',
    logo_url TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- org_members: 업체 멤버 (관리자)
CREATE TABLE org_members (
    id SERIAL PRIMARY KEY,
    org_id INTEGER REFERENCES organizations(id) ON DELETE CASCADE,
    email VARCHAR(100) NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    name VARCHAR(50) NOT NULL,
    role VARCHAR(20) DEFAULT 'viewer',
    telegram_id BIGINT,
    permissions JSONB DEFAULT '[]',
    last_login_at TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(org_id, email)
);

-- org_quotas: 업체 쿼터
CREATE TABLE org_quotas (
    id SERIAL PRIMARY KEY,
    org_id INTEGER REFERENCES organizations(id) ON DELETE CASCADE,
    quota_month VARCHAR(7) NOT NULL,
    private_views_used INTEGER DEFAULT 0,
    private_views_limit INTEGER DEFAULT 10,
    proposals_used INTEGER DEFAULT 0,
    proposals_limit INTEGER DEFAULT 0,
    exports_used INTEGER DEFAULT 0,
    exports_limit INTEGER DEFAULT 1,
    UNIQUE(org_id, quota_month)
);
```

#### 근로자 관련

```sql
-- workers_public: 공개 프로필
CREATE TABLE workers_public (
    id SERIAL PRIMARY KEY,
    public_uid VARCHAR(20) UNIQUE NOT NULL,
    display_name VARCHAR(20),
    region VARCHAR(50),
    sub_regions VARCHAR[] DEFAULT '{}',
    work_types VARCHAR[] DEFAULT '{}',
    trust_score DECIMAL(3,2) DEFAULT 3.00,
    total_jobs INTEGER DEFAULT 0,
    total_hours INTEGER DEFAULT 0,
    avg_rating DECIMAL(2,1) DEFAULT 0.0,
    no_show_rate DECIMAL(4,3) DEFAULT 0.000,
    late_rate DECIMAL(4,3) DEFAULT 0.000,
    home_org_id INTEGER REFERENCES organizations(id),
    visibility_mode VARCHAR(20) DEFAULT 'protected',
    is_available BOOLEAN DEFAULT TRUE,
    last_active_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW()
);

-- workers_private: 개인정보 (암호화)
CREATE TABLE workers_private (
    worker_id INTEGER PRIMARY KEY REFERENCES workers_public(id) ON DELETE CASCADE,
    real_name VARCHAR(50) NOT NULL,
    phone VARCHAR(100),  -- encrypted
    phone_hash VARCHAR(64),
    email VARCHAR(100),
    birthdate DATE,
    gender VARCHAR(10),
    ssn_encrypted BYTEA,
    bank_name VARCHAR(50),
    bank_account VARCHAR(100),  -- encrypted
    bank_holder VARCHAR(50),
    address TEXT,
    emergency_contact VARCHAR(50),
    telegram_id BIGINT UNIQUE,
    profile_photo_url TEXT,
    id_card_verified BOOLEAN DEFAULT FALSE,
    id_card_verified_at TIMESTAMP,
    updated_at TIMESTAMP DEFAULT NOW()
);

-- worker_visibility_settings: 공개 설정
CREATE TABLE worker_visibility_settings (
    worker_id INTEGER PRIMARY KEY REFERENCES workers_public(id) ON DELETE CASCADE,
    visibility_mode VARCHAR(20) DEFAULT 'protected',
    allow_proposals BOOLEAN DEFAULT FALSE,
    blocked_org_ids INTEGER[] DEFAULT '{}',
    preferred_org_ids INTEGER[] DEFAULT '{}',
    home_org_released BOOLEAN DEFAULT FALSE,
    released_at TIMESTAMP,
    release_reason VARCHAR(100)
);
```

#### 이벤트/매칭 관련

```sql
-- events: 이벤트
CREATE TABLE events (
    id SERIAL PRIMARY KEY,
    org_id INTEGER REFERENCES organizations(id) ON DELETE CASCADE,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    event_date DATE NOT NULL,
    start_time TIME,
    end_time TIME,
    location VARCHAR(200),
    location_detail TEXT,
    latitude DECIMAL(10,7),
    longitude DECIMAL(10,7),
    required_workers INTEGER DEFAULT 1,
    confirmed_workers INTEGER DEFAULT 0,
    hourly_rate INTEGER,
    work_types VARCHAR[] DEFAULT '{}',
    requirements TEXT,
    status VARCHAR(20) DEFAULT 'OPEN',
    checkin_code VARCHAR(10),
    checkout_code VARCHAR(10),
    created_by INTEGER REFERENCES org_members(id),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- applications: 지원
CREATE TABLE applications (
    id SERIAL PRIMARY KEY,
    org_id INTEGER REFERENCES organizations(id) ON DELETE CASCADE,
    event_id INTEGER REFERENCES events(id) ON DELETE CASCADE,
    worker_id INTEGER REFERENCES workers_public(id) ON DELETE CASCADE,
    status VARCHAR(20) DEFAULT 'PENDING',
    visibility_level INTEGER DEFAULT 0,
    applied_at TIMESTAMP DEFAULT NOW(),
    reviewed_at TIMESTAMP,
    reviewed_by INTEGER REFERENCES org_members(id),
    confirmed_at TIMESTAMP,
    cancelled_at TIMESTAMP,
    cancel_reason VARCHAR(200),
    note TEXT,
    UNIQUE(event_id, worker_id)
);

-- proposals: 업체 제안
CREATE TABLE proposals (
    id SERIAL PRIMARY KEY,
    org_id INTEGER REFERENCES organizations(id) ON DELETE CASCADE,
    event_id INTEGER REFERENCES events(id) ON DELETE CASCADE,
    worker_id INTEGER REFERENCES workers_public(id) ON DELETE CASCADE,
    status VARCHAR(20) DEFAULT 'SENT',
    message TEXT,
    sent_at TIMESTAMP DEFAULT NOW(),
    responded_at TIMESTAMP,
    response_note TEXT,
    UNIQUE(event_id, worker_id)
);

-- attendance: 출퇴근
CREATE TABLE attendance (
    id SERIAL PRIMARY KEY,
    org_id INTEGER REFERENCES organizations(id) ON DELETE CASCADE,
    event_id INTEGER REFERENCES events(id) ON DELETE CASCADE,
    worker_id INTEGER REFERENCES workers_public(id) ON DELETE CASCADE,
    application_id INTEGER REFERENCES applications(id),
    check_in_time TIMESTAMP,
    check_out_time TIMESTAMP,
    check_in_photo_url TEXT,
    check_out_photo_url TEXT,
    check_in_location POINT,
    check_out_location POINT,
    work_minutes INTEGER,
    status VARCHAR(20) DEFAULT 'PENDING',
    calculated_pay INTEGER,
    note TEXT,
    worker_rating DECIMAL(2,1),
    worker_review TEXT,
    org_rating DECIMAL(2,1),
    org_review TEXT,
    tx_hash VARCHAR(66),
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(event_id, worker_id)
);
```

#### 급여/로그 관련

```sql
-- payroll_exports: 급여 내보내기
CREATE TABLE payroll_exports (
    id SERIAL PRIMARY KEY,
    org_id INTEGER REFERENCES organizations(id) ON DELETE CASCADE,
    export_type VARCHAR(20),
    date_from DATE,
    date_to DATE,
    file_url TEXT,
    file_name VARCHAR(200),
    total_workers INTEGER,
    total_amount BIGINT,
    exported_by INTEGER REFERENCES org_members(id),
    created_at TIMESTAMP DEFAULT NOW()
);

-- access_logs: 접근 로그
CREATE TABLE access_logs (
    id SERIAL PRIMARY KEY,
    org_id INTEGER REFERENCES organizations(id),
    member_id INTEGER REFERENCES org_members(id),
    worker_id INTEGER REFERENCES workers_public(id),
    access_type VARCHAR(30) NOT NULL,
    access_level INTEGER,
    fields_accessed VARCHAR[],
    reason VARCHAR(100),
    ip_address INET,
    user_agent TEXT,
    accessed_at TIMESTAMP DEFAULT NOW()
);

-- chain_logs: 블록체인 기록
CREATE TABLE chain_logs (
    id SERIAL PRIMARY KEY,
    org_id INTEGER REFERENCES organizations(id),
    event_id INTEGER REFERENCES events(id),
    worker_id INTEGER REFERENCES workers_public(id),
    attendance_id INTEGER REFERENCES attendance(id),
    log_hash VARCHAR(66) NOT NULL,
    worker_uid_hash VARCHAR(66),
    tx_hash VARCHAR(66),
    block_number BIGINT,
    chain_id INTEGER,
    status VARCHAR(20) DEFAULT 'PENDING',
    error_message TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    confirmed_at TIMESTAMP
);
```

### 9.3 인덱스 전략

```sql
-- 검색 성능 최적화
CREATE INDEX idx_workers_public_region ON workers_public(region);
CREATE INDEX idx_workers_public_visibility ON workers_public(visibility_mode);
CREATE INDEX idx_workers_public_home_org ON workers_public(home_org_id);
CREATE INDEX idx_workers_public_trust_score ON workers_public(trust_score DESC);
CREATE INDEX idx_workers_public_work_types ON workers_public USING GIN(work_types);

-- 매칭 조회
CREATE INDEX idx_events_org_date ON events(org_id, event_date);
CREATE INDEX idx_events_status ON events(status);
CREATE INDEX idx_applications_event ON applications(event_id);
CREATE INDEX idx_applications_worker ON applications(worker_id);
CREATE INDEX idx_applications_status ON applications(status);

-- 감사 로그
CREATE INDEX idx_access_logs_org_date ON access_logs(org_id, accessed_at);
CREATE INDEX idx_access_logs_worker ON access_logs(worker_id);
```

---

## 10. API 권한 설계

### 10.1 엔드포인트 권한 매트릭스

#### 근로자 API

| 엔드포인트 | 메서드 | 권한 조건 | 반환 레벨 |
|-----------|--------|----------|----------|
| `/workers/public` | GET | 인증된 업체 | Level 0 (visibility=public만) |
| `/workers/public/{id}` | GET | 인증된 업체 | Level 0~2 (관계에 따라) |
| `/workers/private/{id}` | GET | Level 2 접근 권한 | Level 2 |
| `/workers/me` | GET | 근로자 본인 | 전체 |
| `/workers/me` | PATCH | 근로자 본인 | - |
| `/workers/me/visibility` | PATCH | 근로자 본인 | - |

#### 이벤트 API

| 엔드포인트 | 메서드 | 권한 조건 | 비고 |
|-----------|--------|----------|------|
| `/events` | GET | 인증된 업체/근로자 | 업체: 자사만, 근로자: 전체 |
| `/events` | POST | manager 이상 | org_id 자동 설정 |
| `/events/{id}` | GET | 인증됨 | |
| `/events/{id}` | PATCH | 해당 org manager | |
| `/events/{id}/candidates` | GET | 해당 org admin | 지원자 목록 |
| `/events/{id}/apply` | POST | 근로자 | 지원 |

#### 지원/제안 API

| 엔드포인트 | 메서드 | 권한 조건 | 비고 |
|-----------|--------|----------|------|
| `/applications` | GET | org member | 자사 지원만 |
| `/applications/{id}/approve` | POST | manager 이상 | Level 1 공개 |
| `/applications/{id}/reject` | POST | manager 이상 | |
| `/applications/{id}/confirm` | POST | manager 이상 | Level 2 공개 |
| `/proposals` | POST | Pro 이상 + 쿼터 | |
| `/proposals/{id}/accept` | POST | 근로자 본인 | |
| `/proposals/{id}/reject` | POST | 근로자 본인 | |

### 10.2 권한 체크 로직

```python
# 근로자 정보 접근 권한 체크
def check_worker_access(
    requesting_org_id: int,
    worker_id: int,
    required_level: int
) -> tuple[bool, int]:
    """
    Returns: (can_access, actual_level)
    """
    worker = get_worker_public(worker_id)

    # Home Org는 항상 Level 2
    if worker.home_org_id == requesting_org_id:
        return (True, 2)

    # Protected 상태 체크
    if worker.visibility_mode == 'protected':
        # 지원/제안 관계 확인
        app = get_latest_application(requesting_org_id, worker_id)
        if not app:
            return (False, -1)

        app_level = get_application_level(app.status)
        return (app_level >= required_level, app_level)

    # Public 상태
    app = get_latest_application(requesting_org_id, worker_id)
    if not app:
        return (required_level == 0, 0)

    app_level = get_application_level(app.status)
    return (app_level >= required_level, app_level)


def get_application_level(status: str) -> int:
    return {
        'PENDING': 0,
        'APPROVED': 1,
        'CONFIRMED': 2,
        'COMPLETED': 2,
    }.get(status, -1)
```

### 10.3 응답 필터링

```python
# 레벨별 응답 필터
LEVEL_FIELDS = {
    0: [
        'public_uid', 'region', 'trust_score', 'total_jobs',
        'avg_rating', 'no_show_rate', 'late_rate', 'is_available'
    ],
    1: [
        # Level 0 +
        'display_name', 'sub_regions', 'work_types',
        'profile_photo_thumbnail'
    ],
    2: [
        # Level 1 +
        'real_name', 'phone', 'email', 'birthdate',
        'bank_name', 'bank_account', 'bank_holder',
        'address', 'profile_photo_url'
    ]
}

def filter_worker_response(worker_data: dict, level: int) -> dict:
    allowed_fields = set()
    for l in range(level + 1):
        allowed_fields.update(LEVEL_FIELDS.get(l, []))

    return {k: v for k, v in worker_data.items() if k in allowed_fields}
```

---

## 11. 요금제 표

### 11.1 요금제 비교

| 항목 | Free | Basic | Pro | Enterprise |
|------|:----:|:-----:|:---:|:----------:|
| **월 요금** | ₩0 | ₩49,000 | ₩149,000 | 별도 협의 |
| **관리자 계정** | 1명 | 3명 | 10명 | 무제한 |
| **이벤트 생성** | 3건/월 | 20건/월 | 100건/월 | 무제한 |
| **개인정보 열람** | 10건/월 | 50건/월 | 200건/월 | 무제한 |
| **제안 발송** | ❌ | ❌ | 30건/월 | 무제한 |
| **급여 내보내기** | 1건/월 | 5건/월 | 20건/월 | 무제한 |
| **블록체인 기록** | ❌ | ✅ | ✅ | ✅ |
| **API 접근** | ❌ | ❌ | Rate Limited | 전용 |
| **통계 리포트** | 기본 | 기본 | 상세 | 커스텀 |
| **전용 DB** | ❌ | ❌ | ❌ | ✅ |
| **SLA** | ❌ | 99% | 99.5% | 99.9% |
| **지원** | 커뮤니티 | 이메일 | 우선 이메일 | 전담 매니저 |

### 11.2 추가 옵션

| 옵션 | 가격 | 설명 |
|------|------|------|
| 추가 개인정보 열람 | ₩1,000/건 | 월 쿼터 초과 시 |
| 추가 제안 발송 | ₩2,000/건 | Pro 이상 |
| 대량 내보내기 | ₩10,000/회 | 100명 이상 |
| 커스텀 리포트 | ₩50,000/종 | 맞춤형 통계 |
| 온보딩 지원 | ₩200,000 | 초기 설정 대행 |

### 11.3 수익 시뮬레이션

```
목표: 100개 업체 유치 시

Free:     40개 ×     ₩0 =         ₩0
Basic:    35개 × ₩49,000 = ₩1,715,000
Pro:      20개 × ₩149,000 = ₩2,980,000
Enterprise: 5개 × ₩500,000 = ₩2,500,000

월 반복 수익(MRR): ₩7,195,000
연 반복 수익(ARR): ₩86,340,000

+ 추가 사용량 과금: 약 ₩1,000,000/월
= 예상 월 매출: ₩8,200,000
```

---

## 12. MVP 범위

### 12.1 6주 개발 계획

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        MVP 6주 개발 로드맵                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Week 1-2: 기반 구축                                                   │
│  ─────────────────────                                                 │
│  ✅ 멀티테넌트 DB 스키마                                               │
│  ✅ organizations, org_members 테이블                                  │
│  ✅ JWT 인증 (org_id 포함)                                             │
│  ✅ RLS 기본 정책                                                      │
│  ✅ 업체 가입/로그인 API                                               │
│                                                                         │
│  Week 3-4: 핵심 기능                                                   │
│  ─────────────────────                                                 │
│  ✅ workers_public, workers_private 분리                               │
│  ✅ 3단계 정보 공개 모델                                               │
│  ✅ protected/public 모드                                              │
│  ✅ 이벤트 CRUD                                                        │
│  ✅ 근로자 지원형 매칭 플로우                                          │
│  ✅ 출퇴근 체크                                                        │
│                                                                         │
│  Week 5-6: 마무리                                                      │
│  ─────────────────────                                                 │
│  ✅ access_logs 기록                                                   │
│  ✅ 급여 내보내기                                                      │
│  ✅ 기본 대시보드 (React)                                              │
│  ✅ 텔레그램 봇 멀티테넌트 대응                                        │
│  ✅ 요금제 기본 구조                                                   │
│  ✅ 테스트 및 배포                                                     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 12.2 MVP 포함 기능

| 카테고리 | 기능 | 포함 |
|----------|------|:----:|
| **업체 관리** | 업체 가입/로그인 | ✅ |
| | 멤버 관리 (owner, admin) | ✅ |
| | 업체 프로필 설정 | ✅ |
| **근로자** | 가입/로그인 | ✅ |
| | 공개/비공개 프로필 분리 | ✅ |
| | protected/public 모드 | ✅ |
| | 3단계 정보 공개 | ✅ |
| **이벤트** | 이벤트 생성/수정 | ✅ |
| | 이벤트 목록/상세 | ✅ |
| **매칭** | 근로자 지원 | ✅ |
| | 지원 승인/거절/확정 | ✅ |
| | 업체 제안 | ❌ Phase 2 |
| **출퇴근** | 코드 기반 체크인/아웃 | ✅ |
| | QR 코드 체크인 | ❌ Phase 2 |
| | 위치 기반 검증 | ❌ Phase 2 |
| **급여** | 급여 계산 | ✅ |
| | 엑셀 내보내기 | ✅ |
| **블록체인** | 근로 기록 해시 저장 | ✅ |
| | 토큰 발행 | ❌ Phase 2 |
| **보안** | JWT 인증 | ✅ |
| | RLS 기본 정책 | ✅ |
| | access_logs 기록 | ✅ |
| | 쿼터 제한 | ❌ Phase 2 |
| **UI** | 업체 대시보드 | ✅ (기본) |
| | 근로자 웹앱 | ✅ (기본) |
| | 텔레그램 봇 | ✅ |

### 12.3 MVP 제외 (Phase 2)

- 업체 제안형 매칭
- 제안/열람 쿼터 관리
- QR 코드 및 위치 기반 체크인
- 상세 통계 리포트
- API 외부 공개
- 결제 시스템 연동
- 신뢰점수 자동 계산
- 이상 접근 탐지

---

## 13. 확장 로드맵

### 13.1 Phase 2 (MVP + 2개월)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            Phase 2 기능                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  🎯 업체 제안형 매칭                                                   │
│  ├── 근로자 검색 (public 모드)                                        │
│  ├── 제안 발송 및 응답                                                │
│  └── 월간 제안 쿼터 관리                                              │
│                                                                         │
│  📊 쿼터 및 과금                                                       │
│  ├── 요금제별 쿼터 적용                                               │
│  ├── 사용량 추적                                                      │
│  ├── 쿼터 초과 알림                                                   │
│  └── 결제 시스템 연동                                                 │
│                                                                         │
│  📍 향상된 출퇴근                                                      │
│  ├── QR 코드 체크인                                                   │
│  ├── GPS 위치 검증                                                    │
│  ├── 사진 촬영                                                        │
│  └── 지각/조퇴 자동 계산                                              │
│                                                                         │
│  📈 통계 및 리포트                                                     │
│  ├── 업체별 대시보드                                                  │
│  ├── 근로자 성과 분석                                                 │
│  ├── 이벤트 효율 분석                                                 │
│  └── PDF 리포트 생성                                                  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 13.2 Phase 3 (+ 3개월)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            Phase 3 기능                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  🤖 AI 기반 추천                                                       │
│  ├── 신뢰점수 자동 계산                                               │
│  ├── 업체-근로자 매칭 추천                                            │
│  ├── 노쇼 예측                                                        │
│  └── 최적 인원 배치 제안                                              │
│                                                                         │
│  🔗 외부 연동                                                          │
│  ├── 공개 API                                                         │
│  ├── 웹훅 (이벤트 알림)                                               │
│  ├── 급여 시스템 연동                                                 │
│  └── 회계 소프트웨어 연동                                             │
│                                                                         │
│  🛡️ 고급 보안                                                         │
│  ├── 이상 접근 탐지                                                   │
│  ├── IP 화이트리스트                                                  │
│  ├── 2FA 강제                                                         │
│  └── 감사 리포트                                                      │
│                                                                         │
│  🎮 사용자 경험                                                        │
│  ├── 모바일 앱 (React Native)                                         │
│  ├── 푸시 알림                                                        │
│  ├── 실시간 채팅                                                      │
│  └── 다국어 지원                                                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 13.3 장기 비전

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         장기 확장 비전                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  🏢 헤드헌팅 모드                                                      │
│  ├── 프리미엄 인력풀                                                  │
│  ├── 스카우트 제안                                                    │
│  ├── 이적료 모델                                                      │
│  └── 경력 포트폴리오                                                  │
│                                                                         │
│  🌏 해외 확장                                                          │
│  ├── 다국가 지원                                                      │
│  ├── 현지 규정 준수                                                   │
│  ├── 다중 통화                                                        │
│  └── 현지 파트너십                                                    │
│                                                                         │
│  🪙 토큰 이코노미                                                      │
│  ├── WorkProof Token (WPT) 활성화                                     │
│  ├── 근로 보상 토큰                                                   │
│  ├── 스테이킹/거버넌스                                                │
│  └── DeFi 연동                                                        │
│                                                                         │
│  🏛️ 공공 연계                                                         │
│  ├── 고용노동부 연동                                                  │
│  ├── 4대보험 자동 신고                                                │
│  ├── 전자근로계약서                                                   │
│  └── 정부 지원사업 연계                                               │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 부록: 용어 정의

| 용어 | 정의 |
|------|------|
| **Organization (Org)** | WorkProof를 사용하는 업체/기업 |
| **Org Member** | 업체에 소속된 관리자 계정 |
| **Worker** | 근로자 (플랫폼 전체에서 1개 계정) |
| **Home Org** | 근로자가 최초 가입한 업체 |
| **Protected Mode** | 근로자가 Home Org에 의해 보호받는 상태 |
| **Public Mode** | 근로자가 전체 업체에 공개된 상태 |
| **Level 0/1/2** | 정보 공개 단계 (검색/지원수락/근무확정) |
| **Application** | 근로자의 이벤트 지원 |
| **Proposal** | 업체의 근로자 제안 |
| **Trust Score** | 근로자 신뢰점수 (0~5) |

---

**문서 끝**

*이 문서는 WorkProof Chain v2 멀티테넌트 플랫폼의 기획 명세서입니다.*
*실제 구현 시 세부 사항은 변경될 수 있습니다.*
